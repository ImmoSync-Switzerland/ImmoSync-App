name: Android AAB (commit message trigger)

on:
  push:
    branches:
      - '**'

jobs:
  build-aab:
    name: Build Release AAB
    # Only run when the commit message contains the marker "aab"
    if: contains(github.event.head_commit.message, 'aab')
    runs-on: ubuntu-latest
    timeout-minutes: 40

    permissions:
      contents: write
      actions: read
      checks: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.5'
          cache: true

      - name: Flutter doctor
        run: flutter doctor -v

      - name: Restore pub dependencies
        working-directory: immolink
        run: flutter pub get

      - name: Create .env file from secrets
        working-directory: immolink
        env:
          API_URL: ${{ secrets.CLIENT_API_URL }}
          STRIPE_PUBLISHABLE_KEY: ${{ secrets.STRIPE_PUBLISHABLE_KEY }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          MONGODB_DB_NAME: ${{ secrets.MONGODB_DB_NAME }}
          WS_URL: ${{ secrets.WS_URL }}
        run: |
          cat > .env << EOF
          API_URL=${API_URL}
          STRIPE_PUBLISHABLE_KEY=${STRIPE_PUBLISHABLE_KEY}
          GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
          MONGODB_URI=${MONGODB_URI:-}
          MONGODB_DB_NAME=${MONGODB_DB_NAME:-}
          WS_URL=${WS_URL:-}
          EOF

      - name: Create google-services.json from secret
        working-directory: immolink/android/app
        env:
          GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
          GOOGLE_SERVICES_JSON_B64: ${{ secrets.GOOGLE_SERVICES_JSON_B64 }}
        run: |
          RAW_SECRET="$GOOGLE_SERVICES_JSON"
          B64_SECRET="$GOOGLE_SERVICES_JSON_B64"
          if [ -n "$B64_SECRET" ]; then
            echo "$B64_SECRET" | base64 -d > google-services.json
          elif [ -n "$RAW_SECRET" ]; then
            printf '%s' "$RAW_SECRET" > google-services.json
          else
            echo 'Missing google-services.json secret' >&2
            exit 1
          fi

      - name: Build release AAB
        working-directory: immolink
        env:
          API_URL: ${{ secrets.CLIENT_API_URL }}
          STRIPE_PUBLISHABLE_KEY: ${{ secrets.STRIPE_PUBLISHABLE_KEY }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
        run: |
          for v in API_URL STRIPE_PUBLISHABLE_KEY GOOGLE_CLIENT_ID; do
            if [ -z "${!v}" ]; then echo "Missing required secret: $v" >&2; exit 1; fi;
          done
          flutter build appbundle --release \
            --dart-define=API_URL=$API_URL \
            --dart-define=STRIPE_PUBLISHABLE_KEY=$STRIPE_PUBLISHABLE_KEY \
            --dart-define=GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID

      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: immosync-aab
          path: immolink/build/app/outputs/bundle/release/app-release.aab
          retention-days: 7
