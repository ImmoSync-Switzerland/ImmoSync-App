name: Android AAB (commit message trigger)

on:
  push:
    branches:
      - '**'

jobs:
  build-aab:
    name: Build Release AAB
    # Only run when the commit message contains the marker "aab"
    if: contains(github.event.head_commit.message, 'aab')
    runs-on: ubuntu-latest
    timeout-minutes: 40

    permissions:
      contents: write
      actions: read
      checks: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.5'
          cache: true

      - name: Flutter doctor
        run: flutter doctor -v

      - name: Restore pub dependencies
        working-directory: immolink
        run: flutter pub get

      - name: Create .env file from secrets
        working-directory: immolink
        env:
          API_URL: ${{ secrets.CLIENT_API_URL }}
          STRIPE_PUBLISHABLE_KEY: ${{ secrets.STRIPE_PUBLISHABLE_KEY }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          MONGODB_DB_NAME: ${{ secrets.MONGODB_DB_NAME }}
          WS_URL: ${{ secrets.WS_URL }}
        run: |
          cat > .env << EOF
          API_URL=${API_URL}
          STRIPE_PUBLISHABLE_KEY=${STRIPE_PUBLISHABLE_KEY}
          GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
          MONGODB_URI=${MONGODB_URI:-}
          MONGODB_DB_NAME=${MONGODB_DB_NAME:-}
          WS_URL=${WS_URL:-}
          EOF

      - name: Create google-services.json from secret
        working-directory: immolink/android/app
        env:
          GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
          GOOGLE_SERVICES_JSON_B64: ${{ secrets.GOOGLE_SERVICES_JSON_B64 }}
        run: |
          RAW_SECRET="$GOOGLE_SERVICES_JSON"
          B64_SECRET="$GOOGLE_SERVICES_JSON_B64"
          if [ -n "$B64_SECRET" ]; then
            echo "$B64_SECRET" | base64 -d > google-services.json
          elif [ -n "$RAW_SECRET" ]; then
            printf '%s' "$RAW_SECRET" > google-services.json
          else
            echo 'Missing google-services.json secret' >&2
            exit 1
          fi

      - name: Provision release keystore
        working-directory: immolink/android
        env:
          ANDROID_KEYSTORE_B64: ${{ secrets.ANDROID_KEYSTORE_B64 }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          set -euo pipefail
          for v in ANDROID_KEYSTORE_B64 ANDROID_KEYSTORE_PASSWORD ANDROID_KEY_ALIAS ANDROID_KEY_PASSWORD; do
            if [ -z "${!v:-}" ]; then echo "Missing required secret: $v" >&2; exit 1; fi
          done
          echo "$ANDROID_KEYSTORE_B64" | base64 -d > release.keystore
          cat > key.properties <<EOF
          storeFile=release.keystore
          storePassword=${ANDROID_KEYSTORE_PASSWORD}
          keyAlias=${ANDROID_KEY_ALIAS}
          keyPassword=${ANDROID_KEY_PASSWORD}
          EOF
          ls -l release.keystore key.properties

      - name: Build release AAB
        working-directory: immolink
        env:
          API_URL: ${{ secrets.CLIENT_API_URL }}
          STRIPE_PUBLISHABLE_KEY: ${{ secrets.STRIPE_PUBLISHABLE_KEY }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
        run: |
          for v in API_URL STRIPE_PUBLISHABLE_KEY GOOGLE_CLIENT_ID; do
            if [ -z "${!v}" ]; then echo "Missing required secret: $v" >&2; exit 1; fi;
          done
          flutter build appbundle --release \
            --dart-define=API_URL=$API_URL \
            --dart-define=STRIPE_PUBLISHABLE_KEY=$STRIPE_PUBLISHABLE_KEY \
            --dart-define=GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID

      - name: Check Play upload config (optional)
        id: play_check
        env:
          PLAY_SERVICE_ACCOUNT_JSON: ${{ secrets.PLAY_SERVICE_ACCOUNT_JSON }}
        run: |
          if [ -z "${PLAY_SERVICE_ACCOUNT_JSON:-}" ]; then
            echo "Play upload skipped: PLAY_SERVICE_ACCOUNT_JSON not configured" >&2
            echo "ready=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "ready=true" >> "$GITHUB_OUTPUT"

      - name: Decode Play service account JSON
        if: steps.play_check.outputs.ready == 'true'
        id: play_sa
        env:
          PLAY_SERVICE_ACCOUNT_JSON: ${{ secrets.PLAY_SERVICE_ACCOUNT_JSON }}
        run: |
          set -euo pipefail
          # Accept either raw JSON or base64-encoded JSON
          if echo "$PLAY_SERVICE_ACCOUNT_JSON" | base64 --decode >/tmp/play-sa.json 2>/dev/null; then
            SA_JSON=$(cat /tmp/play-sa.json)
          else
            SA_JSON="$PLAY_SERVICE_ACCOUNT_JSON"
          fi
          echo "json=$SA_JSON" >> "$GITHUB_OUTPUT"

      - name: Upload to Play Console (internal track)
        if: steps.play_check.outputs.ready == 'true'
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ steps.play_sa.outputs.json }}
          packageName: ch.immosync.app
          releaseFiles: immolink/build/app/outputs/bundle/release/app-release.aab
          track: internal
          status: completed

      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: immosync-aab
          path: immolink/build/app/outputs/bundle/release/app-release.aab
          retention-days: 7
