name: Android APK CI

on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'public/downloads/**'
  workflow_dispatch:

jobs:
  build-apk:
    name: Build Release APK
    runs-on: ubuntu-latest
    timeout-minutes: 40
    outputs:
      app_version: ${{ steps.extract_version.outputs.app_version }}

    permissions:
      contents: write   # needed if we attach artifact to a GitHub Release later
      actions: read
      checks: read
      security-events: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Set up Flutter
        id: flutter-setup
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.5'   # Updated to include Dart >=3.6.0 for go_router >=15.1.3
          cache: true                  # Use action's default caching (no custom paths)

      - name: Verify Flutter installation
        run: |
          echo "::group::Environment"
          echo "PATH=$PATH"
          echo "Home listing:"; ls -1 $HOME | head -n 50 || true
          echo "Toolcache flutter dirs:"; ls -d $HOME/hostedtoolcache/flutter* 2>/dev/null || echo 'No flutter toolcache dirs'
          echo "::endgroup::"
          if ! command -v flutter >/dev/null 2>&1; then
            echo 'Flutter not found after setup step' >&2
            exit 1
          fi
          flutter --version
          flutter doctor -v | sed -e 's/\x1b\[[0-9;]*m//g'


      # If you prefer a pinned reproducible build, replace the step above with:
      # - name: Set up Flutter (Pinned)
      #   uses: subosito/flutter-action@v2
      #   with:
      #     flutter-version: '3.24.0'
      #     cache: true

      - name: Flutter doctor (redundant safety)
        run: flutter doctor -v

      - name: Restore pub dependencies
        working-directory: immolink
        run: flutter pub get

      - name: Dump dependency tree (releaseRuntimeClasspath)
        working-directory: immolink
        run: |
          echo 'Listing android directory contents:'
          ls -al android | head -n 100
          if [ ! -f android/gradlew ]; then
            echo 'ERROR: gradlew wrapper missing. Commit the Android wrapper files:' >&2
            echo '  immolink/android/gradlew' >&2
            echo '  immolink/android/gradlew.bat' >&2
            echo '  immolink/android/gradle/wrapper/gradle-wrapper.jar' >&2
            echo '  immolink/android/gradle/wrapper/gradle-wrapper.properties' >&2
            exit 1
          fi
          # Normalize potential CRLF line endings (common when committed from Windows)
          if file android/gradlew | grep -qi 'CRLF'; then
            echo 'Converting gradlew line endings to LF'
            sed -i 's/\r$//' android/gradlew
          fi
          chmod +x android/gradlew || true
          set -o pipefail
          # IMPORTANT: Invoke Gradle with -p android so project root is the android/ directory.
          # Calling ./android/gradlew from the parent without -p caused Gradle to treat the current
          # directory (immolink/) as the build root, leading to: "does not contain a Gradle build".
          ./android/gradlew -p android :app:dependencies --configuration releaseRuntimeClasspath > dependency-tree.txt 2>&1 || \
            ./android/gradlew -p android :app:dependencies --configuration releaseRuntimeClasspath --no-daemon > dependency-tree.txt 2>&1 || {
              echo 'Dependency task failed; showing tail:' >&2
              tail -n 200 dependency-tree.txt >&2 || true
              exit 1
            }
          echo '--- Stripe lines ---'
          grep -i 'stripe-android' dependency-tree.txt || echo '(No stripe-android entries found)'

      - name: Assert Stripe SDK version
        working-directory: immolink
        run: |
          # Assert stripe-android meets minimum version requirement (>=20.34.0).
          # Extract resolved versions (handles dynamic mapping lines with '->').
          MATCH_LINES=$(grep -i 'com.stripe:stripe-android' dependency-tree.txt || true)
          if [ -z "$MATCH_LINES" ]; then
            echo 'stripe-android not present in dependency tree' >&2
            exit 1
          fi
          echo "$MATCH_LINES" | sed -E 's/.*-> ([0-9]+\.[0-9]+\.[0-9]+).*/\1/;t; s/.*:([0-9]+\.[0-9]+\.[0-9]+).*/\1/' | while read -r VER; do
            MAJOR=$(echo $VER | cut -d. -f1)
            MINOR=$(echo $VER | cut -d. -f2)
            PATCH=$(echo $VER | cut -d. -f3)
            # Compare version >= 20.34.0
            if [ "$MAJOR" -lt 20 ] || { [ "$MAJOR" -eq 20 ] && [ "$MINOR" -lt 34 ]; }; then
              echo "Resolved stripe-android version $VER is below required 20.34.0" >&2
              exit 1
            fi
          done
          echo 'Verified stripe-android minimum version 20.34.0 satisfied.'

      - name: Upload dependency tree artifact
        uses: actions/upload-artifact@v4
        with:
          name: dependency-tree
          path: immolink/dependency-tree.txt
          retention-days: 7

      - name: Extract app version
        id: extract_version
        run: |
          VERSION_LINE=$(grep '^version:' immolink/pubspec.yaml)
          VERSION=$(echo "$VERSION_LINE" | cut -d ' ' -f2 | tr -d '\r')
          echo "Detected version: $VERSION"
          echo "app_version=$VERSION" >> $GITHUB_OUTPUT

      # (Sanitization removed: using constant artifact name to simplify downstream logic)

      - name: Run analyzer (warnings only)
        run: |
          flutter analyze || true
        working-directory: immolink

      - name: Create google-services.json from secret
        working-directory: immolink/android/app
        env:
          GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
          GOOGLE_SERVICES_JSON_B64: ${{ secrets.GOOGLE_SERVICES_JSON_B64 }}
        run: |
          RAW_SECRET="$GOOGLE_SERVICES_JSON"
          B64_SECRET="$GOOGLE_SERVICES_JSON_B64"
          if [ -n "$B64_SECRET" ]; then
            echo 'Using base64-encoded google-services.json secret'
            echo "$B64_SECRET" | base64 -d > google-services.json || { echo 'Base64 decode failed'; exit 1; }
          elif [ -n "$RAW_SECRET" ]; then
            echo 'Using raw google-services.json secret'
            printf '%s' "$RAW_SECRET" > google-services.json
          else
            echo 'Missing required secret: provide either GOOGLE_SERVICES_JSON (raw JSON) or GOOGLE_SERVICES_JSON_B64 (base64)' >&2
            exit 1
          fi
          # Normalize line endings
          sed -i 's/\r$//' google-services.json || true
          SIZE=$(wc -c < google-services.json | tr -d ' ')
          echo "Wrote google-services.json (size: ${SIZE} bytes)"
          echo "SHA256: $(sha256sum google-services.json | cut -d ' ' -f1)"
          # Quick validation heuristics
          if ! grep -q '"project_number"' google-services.json; then
            echo 'google-services.json missing expected JSON key "project_number". Did you paste firebase.json instead?' >&2
            echo 'First 200 chars:' >&2
            head -c 200 google-services.json >&2 || true
            exit 1
          fi
          if grep -q '{flutter:{platforms' google-services.json; then
            echo 'Detected flutterfire config snippet (firebase.json style) instead of google-services.json. Please download the Android google-services.json from Firebase Console.' >&2
            exit 1
          fi

      - name: Build release APK (dart-defines)
        env:
          API_URL: ${{ secrets.CLIENT_API_URL }}
          STRIPE_PUBLISHABLE_KEY: ${{ secrets.STRIPE_PUBLISHABLE_KEY }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
        run: |
          # Fail early if required defines missing
          for v in API_URL STRIPE_PUBLISHABLE_KEY GOOGLE_CLIENT_ID; do
            if [ -z "${!v}" ]; then echo "Missing required secret: $v" >&2; exit 1; fi; done
          # Performance flags (build cache + incremental Kotlin). Explicitly DISABLE configuration cache.
          # Reason: Flutter plugin's *MinSdkCheck task currently captures non-serializable Gradle internals,
          # causing configuration cache serialization failure (InaccessibleObjectException / disallowed types).
          # We also disable those tasks in app/build.gradle, but forcing the cache on (-Dorg.gradle.configuration-cache=true)
          # overrides gradle.properties and still triggers the failure path. Remove once upstream fixes the issue.
          export GRADLE_OPTS="-Dorg.gradle.configuration-cache=false -Dorg.gradle.caching=true -Dkotlin.incremental=true $GRADLE_OPTS"
          flutter build apk --release --split-per-abi \
            --no-tree-shake-icons \
            --dart-define=API_URL=$API_URL \
            --dart-define=STRIPE_PUBLISHABLE_KEY=$STRIPE_PUBLISHABLE_KEY \
            --dart-define=GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID \
            --verbose
        working-directory: immolink

      - name: Collect R8 mapping & missing rules (diagnostics)
        if: always()
        run: |
          mkdir -p r8-mapping
          # Copy mapping + missing rules if they exist
          if ls immolink/build/app/outputs/mapping/release 1>/dev/null 2>&1; then
            cp -r immolink/build/app/outputs/mapping/release r8-mapping/release || true
            echo 'Contents of missing_rules.txt (if present):'
            if [ -f r8-mapping/release/missing_rules.txt ]; then
              head -n 200 r8-mapping/release/missing_rules.txt || true
            else
              echo '(missing_rules.txt not generated)'
            fi
          else
            echo 'No mapping directory produced.'
          fi

      - name: Upload R8 diagnostics artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: r8-mapping
          path: r8-mapping
          retention-days: 7

      - name: Collect APKs
        if: success()
        run: |
          set -euo pipefail
          APK_ROOT="immolink/build/app/outputs/flutter-apk"
          echo "Listing APK output directory before collection ($APK_ROOT):"
          if [ -d "$APK_ROOT" ]; then
            find "$APK_ROOT" -maxdepth 3 -type f -name "*-release.apk" -printf '%P\n' || true
          else
            echo "APK root directory missing: $APK_ROOT" >&2
          fi

          mkdir -p artifacts
          shopt -s nullglob
          # Gather potential locations (some Flutter/AGP combinations place files inside a 'release' subfolder)
          CANDIDATES=(
            "$APK_ROOT"/*-release.apk
            "$APK_ROOT"/release/*-release.apk
          )
          # Filter out any literal globs left untouched (nullglob handles most, but be defensive)
          APK_LIST=()
          for f in "${CANDIDATES[@]}"; do
            if [ -f "$f" ]; then APK_LIST+=("$f"); fi
          done

            if [ ${#APK_LIST[@]} -eq 0 ]; then
            echo "ERROR: No release APKs found in $APK_ROOT (expected *-release.apk)." >&2
            echo "Directory tree (depth 3) for debugging:" >&2
            find "$APK_ROOT" -maxdepth 3 -type f -printf '%P\n' >&2 || true
            exit 1
          fi

          echo "Found ${#APK_LIST[@]} APK(s):"
          printf '  %s\n' "${APK_LIST[@]}"
          cp "${APK_LIST[@]}" artifacts/
          VERSION="${{ steps.extract_version.outputs.app_version }}"
          echo "Normalizing APK filenames with version ${VERSION}" 
          echo "Raw artifacts after copy:"; ls -1 artifacts || true
          # Create per-ABI versioned copies: immosync-${VERSION}-<abi>.apk
          for f in artifacts/app-*-release.apk; do
            [ -f "$f" ] || continue
            base="${f##*/}"              # e.g. app-arm64-v8a-release.apk
            abi_part="${base#app-}"       # arm64-v8a-release.apk
            abi_part="${abi_part%-release.apk}" # arm64-v8a
            cp "$f" "artifacts/immosync-${VERSION}-${abi_part}.apk"
          done
          # Universal rename if present
          if [ -f artifacts/app-release.apk ]; then
            cp artifacts/app-release.apk "artifacts/immosync-${VERSION}-universal.apk"
            # Prefer universal as main if available
            cp artifacts/app-release.apk "artifacts/immosync-${VERSION}.apk"
          fi
          # If main alias not set yet, pick a preferred ABI precedence order
          if [ ! -f artifacts/immosync-${VERSION}.apk ]; then
            for preferred in arm64-v8a armeabi-v7a x86_64; do
              if [ -f "artifacts/immosync-${VERSION}-${preferred}.apk" ]; then
                cp "artifacts/immosync-${VERSION}-${preferred}.apk" "artifacts/immosync-${VERSION}.apk"
                break
              fi
            done
          fi
          # Fallback: first any *-release.apk if alias still missing
          if [ ! -f artifacts/immosync-${VERSION}.apk ]; then
            first_rel=$(ls artifacts/app-*-release.apk 2>/dev/null | head -n1 || true)
            if [ -n "$first_rel" ]; then cp "$first_rel" "artifacts/immosync-${VERSION}.apk"; fi
          fi
          # Final assert inside build job (fail early rather than later jobs)
          if [ ! -f artifacts/immosync-${VERSION}.apk ]; then
            echo "ERROR: Failed to create primary alias immosync-${VERSION}.apk" >&2
            echo "Listing artifacts directory for debugging:" >&2
            ls -l artifacts >&2 || true
            exit 1
          fi
          # Create latest alias
          if [ -f artifacts/immosync-${VERSION}.apk ]; then
            cp artifacts/immosync-${VERSION}.apk artifacts/immosync-latest.apk
          else
            echo "WARNING: immosync-${VERSION}.apk still not created; available files:" >&2
            ls -1 artifacts >&2 || true
          fi
          echo "Final artifact file set:"; ls -lh artifacts
          # Record metadata (primary + per-ABI) for downstream debugging
          {
            echo "version=${VERSION}";
            echo -n "primary="; basename artifacts/immosync-${VERSION}.apk;
            echo "files="; ls -1 artifacts | sed 's/^/  - /';
          } > artifacts/BUILD_METADATA.txt

      - name: Upload artifact (constant name)
        uses: actions/upload-artifact@v4
        with:
          name: immosync-apk
          path: artifacts
          retention-days: 14

  publish-github-release:
    name: Publish GitHub Release
    needs: build-apk
    runs-on: ubuntu-latest
    if: needs.build-apk.result == 'success'
    permissions:
      contents: write
    steps:
      - name: Download APK artifact
        uses: actions/download-artifact@v4
        with:
          name: immosync-apk
          path: apk
      - name: Validate artifact download
        run: |
          set -euo pipefail
          if [ ! -d apk ]; then echo "Artifact directory 'apk' missing" >&2; exit 1; fi
          ls -lh apk || true
          echo "Downloaded metadata (if present):"; [ -f apk/BUILD_METADATA.txt ] && cat apk/BUILD_METADATA.txt || echo '(no metadata)'
      - name: Normalize filenames
        run: |
          set -euo pipefail
          echo "Downloaded files:"; ls -lh apk
          VERSION="${{ needs.build-apk.outputs.app_version }}"
          # If main alias exists we're done
          if [ ! -f apk/immosync-${VERSION}.apk ]; then
            # Create per-ABI versioned copies if only raw app-* files were uploaded
            for f in apk/app-*-release.apk; do
              [ -f "$f" ] || continue
              base="${f##*/}"; abi_part="${base#app-}"; abi_part="${abi_part%-release.apk}"; cp "$f" "apk/immosync-${VERSION}-${abi_part}.apk"
            done
            if [ -f apk/app-release.apk ]; then
              cp apk/app-release.apk apk/immosync-${VERSION}-universal.apk
              cp apk/app-release.apk apk/immosync-${VERSION}.apk
            fi
            # Choose preferred ABI if alias still missing
            if [ ! -f apk/immosync-${VERSION}.apk ]; then
              for preferred in arm64-v8a armeabi-v7a x86_64; do
                if [ -f "apk/immosync-${VERSION}-${preferred}.apk" ]; then
                  cp "apk/immosync-${VERSION}-${preferred}.apk" apk/immosync-${VERSION}.apk
                  break
                fi
              done
            fi
            # Final fallback
            if [ ! -f apk/immosync-${VERSION}.apk ]; then
              CAND=$(ls apk/*-release.apk 2>/dev/null | head -n1 || true)
              [ -n "$CAND" ] && cp "$CAND" apk/immosync-${VERSION}.apk || true
            fi
          fi
          if [ ! -f apk/immosync-${VERSION}.apk ]; then
            echo "ERROR: Could not determine primary APK to publish." >&2
            ls -lh apk >&2 || true
            exit 1
          fi
          cp apk/immosync-${VERSION}.apk apk/immosync-latest.apk
          ls -lh apk
      - name: Create / Update GitHub Release
        uses: softprops/action-gh-release@v1
        with:
            tag_name: v${{ needs.build-apk.outputs.app_version }}
            name: ImmoSync v${{ needs.build-apk.outputs.app_version }}
            generate_release_notes: true
            files: |
              apk/immosync-${{ needs.build-apk.outputs.app_version }}.apk
              apk/immosync-latest.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate short summary
        run: |
          echo "### Android APK Build" >> $GITHUB_STEP_SUMMARY
          echo "Built on commit $GITHUB_SHA" >> $GITHUB_STEP_SUMMARY
          echo "Artifact file list (from uploaded 'artifacts' directory):" >> $GITHUB_STEP_SUMMARY
          ls -lh artifacts >> $GITHUB_STEP_SUMMARY || echo '(artifacts dir missing?)'

  publish-to-site-repo:
    name: Push APKs to site repository (Option A)
    needs: build-apk
    runs-on: ubuntu-latest
    if: needs.build-apk.result == 'success'
    steps:
      - name: Checkout site repo
        uses: actions/checkout@v4
        with:
          # TODO: Replace below with your real target repo, e.g. org/vercel-site-repo
          repository: FabianBoni/immosync.ch
          # TODO: Replace with: token: ${{ secrets.SITE_REPO_PAT }}  (create PAT secret first)
          token: ${{ secrets.SITE_REPO_PAT }}
          fetch-depth: 0
          path: site

      - name: Download APK artifact
        uses: actions/download-artifact@v4
        with:
          name: immosync-apk
          path: site/apk

      - name: Prepare downloads folder
        env:
          VERSION: ${{ needs.build-apk.outputs.app_version }}
        run: |
          set -euo pipefail
          cd site
          echo "APK directory listing (site/apk):"; ls -lh apk || true
          mkdir -p public/downloads
          VERSION_FILE="immosync-${VERSION}.apk"
          CANDIDATES=()
          # Preferred order of discovery
          [ -f "apk/${VERSION_FILE}" ] && CANDIDATES+=("apk/${VERSION_FILE}")
          [ -f "apk/immosync-latest.apk" ] && CANDIDATES+=("apk/immosync-latest.apk")
          # Any previously versioned APKs
          for f in apk/immosync-*.apk; do [ -f "$f" ] && CANDIDATES+=("$f"); done || true
          # Universal default name
          [ -f apk/app-release.apk ] && CANDIDATES+=("apk/app-release.apk")
          # ABI splits (pick arm64 first, then others)
          for f in apk/app-arm64-v8a-release.apk apk/app-armeabi-v7a-release.apk apk/app-x86_64-release.apk; do
            [ -f "$f" ] && CANDIDATES+=("$f")
          done
          # Generic fallback pattern
          for f in apk/*-release.apk; do [ -f "$f" ] && CANDIDATES+=("$f"); done || true
          # Deduplicate while preserving order
          SEEN=""; FINAL=()
          for f in "${CANDIDATES[@]}"; do
            case " $SEEN " in *" $f "*) ;; *) SEEN="$SEEN $f"; FINAL+=("$f");; esac
          done
          if [ ${#FINAL[@]} -eq 0 ]; then
            echo "ERROR: No APK candidates found to publish." >&2
            find apk -maxdepth 3 -type f -printf '%P\n' || true
            exit 1
          fi
          SRC="${FINAL[0]}"
          echo "Selected APK: $SRC"
          TARGET_VERSIONED="public/downloads/${VERSION_FILE}"
          cp "$SRC" "$TARGET_VERSIONED"
          cp "$SRC" public/downloads/immosync-latest.apk
          # Generate sha256 checksums
          (cd public/downloads && sha256sum "$(basename "$TARGET_VERSIONED")" > "${VERSION_FILE}.sha256" && sha256sum immosync-latest.apk > immosync-latest.apk.sha256)
          # Prune old versioned APKs (keep latest 5 excluding alias)
          ls -1t public/downloads/immosync-*.apk 2>/dev/null | grep -v 'latest' | tail -n +6 | xargs -r rm -f
          # Build a manifest.json listing available versions
          # Build versions JSON array (fix jq pipeline syntax)
          VERS_JSON=$(ls -1 public/downloads/immosync-*.apk 2>/dev/null \
            | grep -v latest \
            | sed 's|public/downloads/||' \
            | sort -r \
            | jq -R -s -c 'split("\n") | map(select(length>0))')
          echo "{\n  \"last_updated_utc\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\n  \"versions\": ${VERS_JSON}\n}" > public/downloads/manifest.json
          # Rebuild index.html
          echo "Generating index.html"
          VLIST=$(ls -1 public/downloads/immosync-*.apk 2>/dev/null | grep -v latest | sed 's|public/downloads/||' | sort -r)
          {
            echo '<!doctype html><html><head><meta charset="utf-8"><title>ImmoSync Downloads</title>'
            echo '<style>body{font-family:system-ui,Segoe UI,Roboto,sans-serif;padding:40px;max-width:760px;margin:auto;background:#0f172a;color:#f1f5f9}a{color:#38bdf8;text-decoration:none}a:hover{text-decoration:underline}code{background:#1e293b;padding:2px 4px;border-radius:4px}ul{line-height:1.6}</style></head><body>'
            echo '<h1>ImmoSync Android Downloads</h1><p><a href="immosync-latest.apk">Download latest APK</a></p><h2>Versioned builds</h2><ul>'
            for f in $VLIST; do echo "<li><a href=\"$f\">$f</a> (<a href=\"$f.sha256\">sha256</a>)</li>"; done
            echo '</ul><p>Manifest: <a href="manifest.json">manifest.json</a></p><p>Last updated: '$(date -u)'</p></body></html>'
          } > public/downloads/index.html
          echo "Final downloads directory:"; ls -lh public/downloads
          # Remove apk folder so its contents aren't committed
          rm -rf apk

      - name: Commit & push
        env:
          GIT_AUTHOR_NAME: github-actions[bot]
          GIT_AUTHOR_EMAIL: 41898282+github-actions[bot]@users.noreply.github.com
          GIT_COMMITTER_NAME: github-actions[bot]
          GIT_COMMITTER_EMAIL: 41898282+github-actions[bot]@users.noreply.github.com
        run: |
          cd site
          git config user.name "$GIT_AUTHOR_NAME"
          git config user.email "$GIT_AUTHOR_EMAIL"
          git add public/downloads
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi
            VERSION=${{ needs.build-apk.outputs.app_version }}
          git commit -m "chore: publish APK ${VERSION}" --no-verify
          git push

      - name: Summary
        env:
          VERSION: ${{ needs.build-apk.outputs.app_version }}
        run: |
          echo "### Cross-Repo APK Publish" >> $GITHUB_STEP_SUMMARY
          echo "Pushed immosync-${VERSION}.apk + latest alias to site repo" >> $GITHUB_STEP_SUMMARY

  # Optional job to create a draft release (commented out)
  # release:
  #   needs: build-apk
  #   runs-on: ubuntu-latest
  #   if: startsWith(github.ref, 'refs/heads/main')
  #   steps:
  #     - name: Download artifact
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: android-apk
  #     - name: Create GitHub Release
  #       uses: softprops/action-gh-release@v2
  #       with:
  #         draft: true
  #         files: |\n  #           *.apk
