version: '3.8'

# Production docker-compose template for Synapse (Matrix) + Element (web client)
# - This template expects you to generate and edit /opt/matrix/synapse/data/homeserver.yaml
#   to point to your AWS Postgres and to set registration_shared_secret.
# - Mount a host directory with your synapse data (e.g. /opt/matrix/synapse/data)

services:
  synapse:
    image: matrixdotorg/synapse:latest
    container_name: synapse
    restart: unless-stopped
    environment:
      - SYNAPSE_SERVER_NAME=${SYNAPSE_SERVER_NAME}
      - SYNAPSE_REPORT_STATS=no
    volumes:
      - ${SYNAPSE_DATA_DIR:-./synapse/data}:/data
    ports:
      - "8008:8008" # client-server API (you will usually proxy this through nginx)

  element:
    image: vectorim/element-web:latest
    container_name: element
    restart: unless-stopped
    volumes:
      - ${ELEMENT_CONFIG_DIR:-./element/config}:/app/config
    environment:
      - CONFIG_JSON=/app/config/config.json
    ports:
      - "8082:80"

# Optional TURN (coturn) for WebRTC (voice/video) - uncomment and configure if needed
#  coturn:
#    image: instrumentisto/coturn
#    container_name: coturn
#    restart: unless-stopped
#    environment:
#      - REALM=${SYNAPSE_SERVER_NAME}
#      - LISTEN_PORT=3478
#      - EXTERNAL_IP=${COTURN_PUBLIC_IP}
#    ports:
#      - "3478:3478/udp"
#      - "3478:3478/tcp"

networks:
  default:
    name: matrix-net
    driver: bridge
