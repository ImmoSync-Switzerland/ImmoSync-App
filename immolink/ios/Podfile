platform :ios, '15.0'

# Explicitly load installer types to avoid CocoaPods 1.16+ NameError on Ruby 3.3 runners
require 'cocoapods/installer/installation_options'

# CocoaPods analytics sends network stats synchronously affecting flutter build latency.
ENV['COCOAPODS_DISABLE_STATS'] = 'true'
# Some pods (e.g., Stripe) can fail when shallow-cloned on CI runners; force full clones to avoid tag lookup errors.
ENV['COCOAPODS_DISABLE_GIT_DEPTH'] = 'true'

project 'Runner', {
  'Debug' => :debug,
  'Profile' => :release,
  'Release' => :release,
}

def flutter_root
  generated_xcode_build_settings_path = File.expand_path(File.join('..', 'Flutter', 'Generated.xcconfig'), __FILE__)
  unless File.exist?(generated_xcode_build_settings_path)
    raise "#{generated_xcode_build_settings_path} must exist. If you're running pod install manually, run:\n  flutter pub get\n  flutter precache --ios\n"
  end

  File.foreach(generated_xcode_build_settings_path) do |line|
    matches = line.match(/FLUTTER_ROOT\=(.*)/)
    return matches[1].strip if matches
  end
  raise "FLUTTER_ROOT not found in #{generated_xcode_build_settings_path}. Try deleting Flutter/Generated.xcconfig and run flutter pub get."
end

require File.expand_path(File.join('packages', 'flutter_tools', 'bin', 'podhelper'), flutter_root)

flutter_ios_podfile_setup

target 'Runner' do
  # FlutterFire recommends static frameworks to avoid Swift module import issues (e.g. GoogleUtilities_AppDelegateSwizzler).
  $FirebaseAsStaticFramework = true
  use_frameworks! :linkage => :static
  use_modular_headers!

  # Ensure FirebaseAuth dependency for app delegate swizzling is present
  pod 'GoogleUtilities/AppDelegateSwizzler'

  flutter_install_all_ios_pods File.dirname(File.realpath(__FILE__))
end

post_install do |installer|
  # CocoaPods 1.16+ drops installer.platform_name; provide a safe shim to keep older hooks working.
  installer.define_singleton_method(:platform_name) do
    pods_project.targets.map { |t| t.respond_to?(:platform_name) ? t.platform_name : nil }.compact.first || :ios
  end unless installer.respond_to?(:platform_name)

  # CocoaPods 1.16+ also removes installer.deployment_target; provide a shim for Flutter's podhelper.
  installer.define_singleton_method(:deployment_target) do
    # Prefer the Podfile platform if available, else fall back to 15.0 (our declared platform)
    platform = installer.podfile.target_definition_list.map(&:platform).compact.first
    if platform.respond_to?(:deployment_target)
      platform.deployment_target.to_s
    else
      '15.0'
    end
  end unless installer.respond_to?(:deployment_target)

  installer.pods_project.targets.each do |target|
    target.build_configurations.each do |config|
      config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '15.0'
      flags = Array(config.build_settings['OTHER_SWIFT_FLAGS']).dup
      flags << '-enable-experimental-feature' << 'AccessLevelOnImport'
      config.build_settings['OTHER_SWIFT_FLAGS'] = flags
    end
    flutter_additional_ios_build_settings(target)
  end

  # Patch Firebase pods to strip Swift 6-only syntax that Xcode 15.4 cannot compile.
  patches = [
    { file: 'FirebaseDataEncoder.swift', from: '-> sending Any', to: '-> Any' },
    { file: 'UnfairLock.swift', from: /\bsending\s+/, to: '' },
    { file: 'HeartbeatsPayload.swift', from: /^(internal|package)\s+import/, to: 'import' },
    { file: 'UnfairLock.swift', from: /^(private|package)\s+import/, to: 'import' }
  ]

  patches.each do |patch|
    Dir.glob(File.join(installer.sandbox.root, '**', patch[:file])).each do |path|
      contents = File.read(path)
      fixed = contents.gsub(patch[:from], patch[:to])
      File.write(path, fixed) if fixed != contents
    end
  end
end
