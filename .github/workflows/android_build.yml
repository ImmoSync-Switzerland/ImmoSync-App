name: Android APK CI

on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'public/downloads/**'
  workflow_dispatch:

jobs:
  build-apk:
    name: Build Release APK
    runs-on: ubuntu-latest
    timeout-minutes: 25
    outputs:
      app_version: ${{ steps.extract_version.outputs.app_version }}

    permissions:
      contents: write   # needed if we attach artifact to a GitHub Release later
      actions: read
      checks: read
      security-events: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Set up Flutter
        id: flutter-setup
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.5'   # Updated to include Dart >=3.6.0 for go_router >=15.1.3
          cache: true                  # Use action's default caching (no custom paths)

      - name: Verify Flutter installation
        run: |
          echo "::group::Environment"
          echo "PATH=$PATH"
          echo "Home listing:"; ls -1 $HOME | head -n 50 || true
          echo "Toolcache flutter dirs:"; ls -d $HOME/hostedtoolcache/flutter* 2>/dev/null || echo 'No flutter toolcache dirs'
          echo "::endgroup::"
          if ! command -v flutter >/dev/null 2>&1; then
            echo 'Flutter not found after setup step' >&2
            exit 1
          fi
          flutter --version
          flutter doctor -v | sed -e 's/\x1b\[[0-9;]*m//g'


      # If you prefer a pinned reproducible build, replace the step above with:
      # - name: Set up Flutter (Pinned)
      #   uses: subosito/flutter-action@v2
      #   with:
      #     flutter-version: '3.24.0'
      #     cache: true

      - name: Flutter doctor (redundant safety)
        run: flutter doctor -v

      - name: Restore pub dependencies
        working-directory: immolink
        run: flutter pub get

      - name: Dump dependency tree (releaseRuntimeClasspath)
        working-directory: immolink
        run: |
          echo 'Listing android directory contents:'
          ls -al android | head -n 100
          if [ ! -f android/gradlew ]; then
            echo 'ERROR: gradlew wrapper missing. Commit the Android wrapper files:' >&2
            echo '  immolink/android/gradlew' >&2
            echo '  immolink/android/gradlew.bat' >&2
            echo '  immolink/android/gradle/wrapper/gradle-wrapper.jar' >&2
            echo '  immolink/android/gradle/wrapper/gradle-wrapper.properties' >&2
            exit 1
          fi
          # Normalize potential CRLF line endings (common when committed from Windows)
          if file android/gradlew | grep -qi 'CRLF'; then
            echo 'Converting gradlew line endings to LF'
            sed -i 's/\r$//' android/gradlew
          fi
          chmod +x android/gradlew || true
          set -o pipefail
          ./android/gradlew :app:dependencies --configuration releaseRuntimeClasspath > dependency-tree.txt 2>&1 || \
            ./android/gradlew :app:dependencies --configuration releaseRuntimeClasspath --no-daemon > dependency-tree.txt 2>&1 || {
              echo 'Dependency task failed; showing tail:' >&2
              tail -n 200 dependency-tree.txt >&2 || true
              exit 1
            }
          echo '--- Stripe lines ---'
          grep -i 'stripe-android' dependency-tree.txt || echo '(No stripe-android entries found)'

      - name: Upload dependency tree artifact
        uses: actions/upload-artifact@v4
        with:
          name: dependency-tree
          path: immolink/dependency-tree.txt
          retention-days: 7

      - name: Extract app version
        id: extract_version
        run: |
          VERSION_LINE=$(grep '^version:' immolink/pubspec.yaml)
          VERSION=$(echo "$VERSION_LINE" | cut -d ' ' -f2 | tr -d '\r')
          echo "Detected version: $VERSION"
          echo "app_version=$VERSION" >> $GITHUB_OUTPUT

      - name: Run analyzer (warnings only)
        run: |
          flutter analyze || true
        working-directory: immolink

      - name: Create google-services.json from secret
        working-directory: immolink/android/app
        env:
          GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
          GOOGLE_SERVICES_JSON_B64: ${{ secrets.GOOGLE_SERVICES_JSON_B64 }}
        run: |
          RAW_SECRET="$GOOGLE_SERVICES_JSON"
          B64_SECRET="$GOOGLE_SERVICES_JSON_B64"
          if [ -n "$B64_SECRET" ]; then
            echo 'Using base64-encoded google-services.json secret'
            echo "$B64_SECRET" | base64 -d > google-services.json || { echo 'Base64 decode failed'; exit 1; }
          elif [ -n "$RAW_SECRET" ]; then
            echo 'Using raw google-services.json secret'
            printf '%s' "$RAW_SECRET" > google-services.json
          else
            echo 'Missing required secret: provide either GOOGLE_SERVICES_JSON (raw JSON) or GOOGLE_SERVICES_JSON_B64 (base64)' >&2
            exit 1
          fi
          # Normalize line endings
          sed -i 's/\r$//' google-services.json || true
          SIZE=$(wc -c < google-services.json | tr -d ' ')
          echo "Wrote google-services.json (size: ${SIZE} bytes)"
          echo "SHA256: $(sha256sum google-services.json | cut -d ' ' -f1)"
          # Quick validation heuristics
          if ! grep -q '"project_number"' google-services.json; then
            echo 'google-services.json missing expected JSON key "project_number". Did you paste firebase.json instead?' >&2
            echo 'First 200 chars:' >&2
            head -c 200 google-services.json >&2 || true
            exit 1
          fi
          if grep -q '{flutter:{platforms' google-services.json; then
            echo 'Detected flutterfire config snippet (firebase.json style) instead of google-services.json. Please download the Android google-services.json from Firebase Console.' >&2
            exit 1
          fi

      - name: Build release APK (dart-defines)
        env:
          API_URL: ${{ secrets.CLIENT_API_URL }}
          STRIPE_PUBLISHABLE_KEY: ${{ secrets.STRIPE_PUBLISHABLE_KEY }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
        run: |
          # Fail early if required defines missing
          for v in API_URL STRIPE_PUBLISHABLE_KEY GOOGLE_CLIENT_ID; do
            if [ -z "${!v}" ]; then echo "Missing required secret: $v" >&2; exit 1; fi; done
          flutter build apk --release --split-per-abi \
            --dart-define=API_URL=$API_URL \
            --dart-define=STRIPE_PUBLISHABLE_KEY=$STRIPE_PUBLISHABLE_KEY \
            --dart-define=GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID
        working-directory: immolink

      - name: Collect R8 mapping & missing rules (diagnostics)
        if: always()
        run: |
          mkdir -p r8-mapping
          # Copy mapping + missing rules if they exist
          if ls immolink/build/app/outputs/mapping/release 1>/dev/null 2>&1; then
            cp -r immolink/build/app/outputs/mapping/release r8-mapping/release || true
            echo 'Contents of missing_rules.txt (if present):'
            if [ -f r8-mapping/release/missing_rules.txt ]; then
              head -n 200 r8-mapping/release/missing_rules.txt || true
            else
              echo '(missing_rules.txt not generated)'
            fi
          else
            echo 'No mapping directory produced.'
          fi

      - name: Upload R8 diagnostics artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: r8-mapping
          path: r8-mapping
          retention-days: 7

      - name: Collect APKs
        if: success()
        run: |
          mkdir -p artifacts
          cp immolink/build/app/outputs/flutter-apk/*-release.apk artifacts/ || echo "No split APKs found"
          cp immolink/build/app/outputs/flutter-apk/app-release.apk artifacts/ || echo "No universal APK found"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: artifacts
          retention-days: 14

      - name: Generate short summary
        run: |
          echo "### Android APK Build" >> $GITHUB_STEP_SUMMARY
          echo "Built on commit $GITHUB_SHA" >> $GITHUB_STEP_SUMMARY
          ls -lh artifacts >> $GITHUB_STEP_SUMMARY

  publish-to-site-repo:
    name: Push APKs to site repository (Option A)
    needs: build-apk
    runs-on: ubuntu-latest
    if: needs.build-apk.result == 'success'
    steps:
      - name: Download APK artifact
        uses: actions/download-artifact@v4
        with:
          name: android-apk
          path: apk

      - name: Checkout site repo
        uses: actions/checkout@v4
        with:
          # TODO: Replace below with your real target repo, e.g. org/vercel-site-repo
          repository: FabianBoni/immosync.ch
          # TODO: Replace with: token: ${{ secrets.SITE_REPO_PAT }}  (create PAT secret first)
          token: ${{ secrets.SITE_REPO_PAT }}
          fetch-depth: 0

      - name: Prepare downloads folder
        env:
          VERSION: ${{ needs.build-apk.outputs.app_version }}
        run: |
          mkdir -p public/downloads
          if [ -f apk/app-release.apk ]; then
            SRC=apk/app-release.apk
          else
            SRC=$(ls apk/*-release.apk 2>/dev/null | head -n 1)
          fi
          if [ -z "$SRC" ]; then
            echo "No APK to publish" >&2
            exit 1
          fi
          cp "$SRC" public/downloads/immosync-latest.apk
          cp "$SRC" "public/downloads/immosync-${VERSION}.apk"
          # Prune old versioned APKs (keep latest 5 excluding alias)
          ls -1t public/downloads/immosync-*.apk 2>/dev/null | grep -v 'latest' | tail -n +6 | xargs -r rm -f
          # Rebuild index.html listing available versions
          echo "Generating index.html"
          VLIST=$(ls -1 public/downloads/immosync-*.apk 2>/dev/null | grep -v latest | sed 's|public/downloads/||' | sort -r)
          {
            echo '<!doctype html><html><head><meta charset="utf-8"><title>ImmoSync Downloads</title>'
            echo '<style>body{font-family:system-ui,Segoe UI,Roboto,sans-serif;padding:40px;max-width:760px;margin:auto;background:#0f172a;color:#f1f5f9}a{color:#38bdf8;text-decoration:none}a:hover{text-decoration:underline}code{background:#1e293b;padding:2px 4px;border-radius:4px}ul{line-height:1.6}</style></head><body>'
            echo '<h1>ImmoSync Android Downloads</h1><p><a href="immosync-latest.apk">Download latest APK</a></p><h2>Versioned builds</h2><ul>'
            for f in $VLIST; do echo "<li><a href=\"$f\">$f</a></li>"; done
            echo '</ul><p>Last updated: '$(date -u)'</p></body></html>'
          } > public/downloads/index.html
          ls -lh public/downloads

      - name: Commit & push
        env:
          GIT_AUTHOR_NAME: github-actions[bot]
          GIT_AUTHOR_EMAIL: 41898282+github-actions[bot]@users.noreply.github.com
          GIT_COMMITTER_NAME: github-actions[bot]
          GIT_COMMITTER_EMAIL: 41898282+github-actions[bot]@users.noreply.github.com
        run: |
          git config user.name "$GIT_AUTHOR_NAME"
          git config user.email "$GIT_AUTHOR_EMAIL"
          git add public/downloads
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi
            VERSION=${{ needs.build-apk.outputs.app_version }}
          git commit -m "chore: publish APK ${VERSION}" --no-verify
          git push

      - name: Summary
        env:
          VERSION: ${{ needs.build-apk.outputs.app_version }}
        run: |
          echo "### Cross-Repo APK Publish" >> $GITHUB_STEP_SUMMARY
          echo "Pushed immosync-${VERSION}.apk + latest alias to site repo" >> $GITHUB_STEP_SUMMARY

  # Optional job to create a draft release (commented out)
  # release:
  #   needs: build-apk
  #   runs-on: ubuntu-latest
  #   if: startsWith(github.ref, 'refs/heads/main')
  #   steps:
  #     - name: Download artifact
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: android-apk
  #     - name: Create GitHub Release
  #       uses: softprops/action-gh-release@v2
  #       with:
  #         draft: true
  #         files: |\n  #           *.apk
